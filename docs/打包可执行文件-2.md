
# 一键打包前后端为单个exe的解决方案

基于您的需求，我创建了一个完整的解决方案，支持日常开发调试和一键打包为单个exe。这个方案包含以下几个部分：

## 1. 创建后端打包脚本

首先，在backend目录下创建一个`build_backend.py`文件：

```python
# backend/build_backend.py
import PyInstaller.__main__
import os
import sys

def build_backend():
    print("开始打包后端...")
    
    # 确保PyInstaller已安装
    try:
        import PyInstaller
    except ImportError:
        print("正在安装PyInstaller...")
        os.system(f"{sys.executable} -m pip install pyinstaller")
    
    # 定义PyInstaller参数
    args = [
        'app.py',
        '--name=kvs_backend',
        '--onefile',
        '--noconsole',
        '--hidden-import=routes.api',
        '--hidden-import=routes.kv',
        '--hidden-import=models',
        '--hidden-import=utils.logger',
    ]
    
    # 添加数据文件（如果有）
    if os.path.exists('templates'):
        args.append('--add-data=templates;templates')
    if os.path.exists('static'):
        args.append('--add-data=static;static')
    
    # 运行PyInstaller
    PyInstaller.__main__.run(args)
    
    print("后端打包完成！")
    return os.path.abspath(os.path.join('dist', 'kvs_backend.exe'))

if __name__ == "__main__":
    build_backend()
```

## 2. 修改Tauri配置

更新`frontend/src-tauri/tauri.conf.json`文件，添加后端可执行文件作为资源：

```json
{
  "tauri": {
    "bundle": {
      "resources": [
        "../../backend/dist/kvs_backend.exe"
      ],
      // 其他配置保持不变...
    }
  }
}
```

## 3. 修改Tauri主程序

更新`frontend/src-tauri/src/main.rs`文件，添加启动后端的代码：

```rust
// Prevents additional console window on Windows in release, DO NOT REMOVE!!
#![cfg_attr(not(debug_assertions), windows_subsystem = "windows")]

use std::process::Command;
use std::thread;
use std::path::PathBuf;
use std::fs;
use tauri::api::path::{app_local_data_dir, resource_dir};

fn main() {
  tauri::Builder::default()
    .setup(|app| {
      // 仅在生产环境中启动内置后端
      #[cfg(not(debug_assertions))]
      {
        // 获取资源目录和应用数据目录
        let resource_path = resource_dir(app.package_info()).unwrap();
        let backend_exe = resource_path.join("kvs_backend.exe");
        
        let local_data_dir = app_local_data_dir(&app.config()).unwrap();
        let backend_dir = local_data_dir.join("backend");
        
        // 创建后端目录
        fs::create_dir_all(&backend_dir).unwrap();
        
        // 复制后端可执行文件
        let target_path = backend_dir.join("kvs_backend.exe");
        fs::copy(backend_exe, &target_path).unwrap();
        
        // 启动后端
        thread::spawn(move || {
          println!("Starting backend from: {:?}", target_path);
          
          let _child = Command::new(target_path)
            .spawn()
            .expect("Failed to start backend process");
        });
      }
      
      Ok(())
    })
    .run(tauri::generate_context!())
    .expect("error while running tauri application");
}
```

## 4. 创建一键打包脚本

在项目根目录创建`build.bat`文件：

```batch
@echo off
echo === KVs 一键打包脚本 ===
echo.

echo 1. 安装依赖...
cd frontend
call npm install
cd ..
cd backend
pip install -r requirements.txt
pip install pyinstaller
cd ..

echo.
echo 2. 打包后端...
cd backend
python build_backend.py
cd ..

echo.
echo 3. 打包前端...
cd frontend
call npm run tauri build
cd ..

echo.
echo === 打包完成! ===
echo 可执行文件位于: frontend\src-tauri\target\release\bundle\
echo.
pause
```

## 5. 更新package.json

在`frontend/package.json`中添加一个打包脚本：

```json
{
  "scripts": {
    // 保留现有脚本...
    "build-all": "cd .. && build.bat"
  }
}
```

## 使用方法

### 日常开发调试

您已经有了`npm run dev-with-backend`命令，可以继续使用它进行日常开发调试：

```bash
cd frontend
npm run dev-with-backend
```

### 一键打包

有两种方式可以一键打包：

1. 直接运行根目录的`build.bat`脚本
2. 使用npm脚本：

```bash
cd frontend
npm run build-all
```

打包完成后，可执行文件将位于`frontend/src-tauri/target/release/bundle/`目录中。

## 注意事项

1. 确保在打包前已安装所有依赖
2. 打包过程可能需要几分钟时间，取决于您的计算机性能
3. 如果后端有特殊依赖项，可能需要在`build_backend.py`中添加相应的`--hidden-import`参数
4. 如果遇到权限问题，请以管理员身份运行命令提示符

这个解决方案既支持您的日常开发需求，又提供了一键打包功能，将前后端打包为单个exe文件。